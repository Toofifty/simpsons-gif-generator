import { Box, Flex, Stack, Text, useMantineTheme } from '@mantine/core';
import { useState } from 'react';
import { useMediaQuery } from '@mantine/hooks';
import { withTransition } from '../util/with-transition';
import { ClipList } from '../components/browse/clip-list';
import { ClipListByEpisode } from '../components/browse/clip-list-by-episode';
import { Navigate, useNavigate, useParams } from 'react-router-dom';
import { CustomSegmentedControl } from '../components/custom-segmented-control';

export default () => {
  const [filetype, setFiletype] = useState<'gif' | 'mp4'>('gif');
  const { sort } = useParams<{
    sort: 'season' | 'popular' | 'recent';
  }>();
  const navigate = useNavigate();

  const theme = useMantineTheme();
  const isTablet = useMediaQuery(`(max-width: ${theme.breakpoints.md})`);
  const isMobile = useMediaQuery(`(max-width: ${theme.breakpoints.sm})`);

  if (!sort || !['season', 'popular', 'recent'].includes(sort)) {
    return <Navigate to="/browse/recent" replace />;
  }

  return (
    <>
      <style>{`body { overflow-y: scroll; overflow-x: hidden; }`}</style>
      <Box mx="auto" maw="calc(1284px)">
        <Stack m="sm" mt="0">
          <Flex
            justify="space-between"
            align={isTablet ? undefined : 'end'}
            mb="lg"
            gap="lg"
            direction={isTablet ? 'column' : undefined}
          >
            <Flex direction="column" style={{ flexShrink: 1 }}>
              <Text component="h1" size="2rem" my={0}>
                Browse
              </Text>
              <Text size="md" color="dimmed">
                View GIFs and MP4s generated by other users
              </Text>
            </Flex>
            <Flex justify="end">
              <Flex
                align="center"
                justify={isTablet ? 'start' : 'end'}
                wrap={isTablet ? 'wrap' : undefined}
                gap="xs"
              >
                <CustomSegmentedControl
                  label="Display"
                  data={[
                    { label: 'GIFs', value: 'gif' },
                    { label: 'MP4s', value: 'mp4' },
                  ]}
                  value={filetype}
                  onChange={withTransition(setFiletype) as any}
                />
                <Flex>
                  <CustomSegmentedControl
                    label="Sorted by"
                    w={isMobile ? '100%' : 'auto'}
                    color="blue"
                    data={[
                      { label: 'Season', value: 'season' },
                      { label: 'Popularity', value: 'popular' },
                      { label: 'Most recent', value: 'recent' },
                    ]}
                    value={sort}
                    onChange={(v) =>
                      navigate(`/browse/${v}`, { viewTransition: true })
                    }
                  />
                </Flex>
              </Flex>
            </Flex>
          </Flex>
          {sort === 'season' ? (
            <ClipListByEpisode filetype={filetype} />
          ) : (
            <ClipList filetype={filetype} sort={sort} />
          )}
        </Stack>
      </Box>
    </>
  );
};
